import ILI9341
import network
import urequests
import time
from machine import Pin, PWM

# ================= TFT LCD PINS =================
LCD_RD  = 2
  
LCD_WR  = 4
LCD_RST = 5
LCD_RS  = 32
LCD_CS  = 33
LCD_D0 = 12
LCD_D1 = 13
LCD_D2 = 14
LCD_D3 = 15
LCD_D4 = 18
LCD_D5 = 19
LCD_D6 = 21
LCD_D7 = 22

# ================= INITIALIZE TFT =================
tft = ILI9341.screen(
    LCD_RD, LCD_WR, LCD_RS,
    LCD_CS, LCD_RST,
    LCD_D0, LCD_D1, LCD_D2, LCD_D3,
    LCD_D4, LCD_D5, LCD_D6, LCD_D7
)
tft.begin()
tft.setrotation(1)
tft.fillscreen(0x0000)

# ================= LARGE FONT CLASS =================
class LargeText:
    FONT = {
        'A':[0x7E,0x09,0x09,0x09,0x7E],'B':[0x7F,0x49,0x49,0x49,0x36],
        'C':[0x3E,0x41,0x41,0x41,0x22],'D':[0x7F,0x41,0x41,0x41,0x3E],
        'E':[0x7F,0x49,0x49,0x49,0x41],'F':[0x7F,0x09,0x09,0x09,0x01],
        'G':[0x3E,0x41,0x49,0x49,0x2E],'H':[0x7F,0x08,0x08,0x08,0x7F],
        'I':[0x00,0x41,0x7F,0x41,0x00],'J':[0x20,0x40,0x41,0x3F,0x01],
        'K':[0x7F,0x08,0x14,0x22,0x41],'L':[0x7F,0x40,0x40,0x40,0x40],
        'M':[0x7F,0x02,0x04,0x02,0x7F],'N':[0x7F,0x02,0x04,0x08,0x7F],
        'O':[0x3E,0x41,0x41,0x41,0x3E],'P':[0x7F,0x09,0x09,0x09,0x06],
        'Q':[0x3E,0x41,0x51,0x21,0x5E],'R':[0x7F,0x09,0x19,0x29,0x46],
        'S':[0x46,0x49,0x49,0x49,0x31],'T':[0x01,0x01,0x7F,0x01,0x01],
        'U':[0x3F,0x40,0x40,0x40,0x3F],'V':[0x1F,0x20,0x40,0x20,0x1F],
        'W':[0x7F,0x20,0x10,0x20,0x7F],'X':[0x63,0x14,0x08,0x14,0x63],
        'Y':[0x07,0x08,0x70,0x08,0x07],'Z':[0x61,0x51,0x49,0x45,0x43],
        'a':[0x20,0x54,0x54,0x54,0x78],'b':[0x7F,0x48,0x44,0x44,0x38],
        'c':[0x38,0x44,0x44,0x44,0x20],'d':[0x38,0x44,0x44,0x44,0x7F],
        'e':[0x38,0x54,0x54,0x54,0x18],'f':[0x08,0x7E,0x09,0x01,0x02],
        'g':[0x0C,0x52,0x52,0x52,0x3E],'h':[0x7F,0x08,0x04,0x04,0x78],
        'i':[0x00,0x44,0x7D,0x40,0x00],'j':[0x20,0x40,0x44,0x3D,0x00],
        'k':[0x7F,0x10,0x28,0x44,0x00],'l':[0x00,0x41,0x7F,0x40,0x00],
        'm':[0x7C,0x04,0x18,0x04,0x78],'n':[0x7C,0x08,0x04,0x04,0x78],
        'o':[0x38,0x44,0x44,0x44,0x38],'p':[0x7C,0x14,0x14,0x14,0x08],
        'q':[0x08,0x14,0x14,0x14,0x7C],'r':[0x7C,0x08,0x04,0x04,0x08],
        's':[0x48,0x54,0x54,0x54,0x20],'t':[0x04,0x3F,0x44,0x40,0x20],
        'u':[0x3C,0x40,0x40,0x20,0x7C],'v':[0x1C,0x20,0x40,0x20,0x1C],
        'w':[0x3C,0x40,0x30,0x40,0x3C],'x':[0x44,0x28,0x10,0x28,0x44],
        'y':[0x0C,0x50,0x50,0x50,0x3C],'z':[0x44,0x64,0x54,0x4C,0x44],
        '0':[0x3E,0x45,0x49,0x51,0x3E],'1':[0x00,0x41,0x7F,0x40,0x00],
        '2':[0x42,0x61,0x51,0x49,0x46],'3':[0x21,0x41,0x45,0x4B,0x31],
        '4':[0x18,0x14,0x12,0x7F,0x10],'5':[0x27,0x45,0x45,0x45,0x39],
        '6':[0x3C,0x4A,0x49,0x49,0x30],'7':[0x01,0x71,0x09,0x05,0x03],
        '8':[0x36,0x49,0x49,0x49,0x36],'9':[0x06,0x49,0x49,0x29,0x1E],
        ' ':[0x00,0x00,0x00,0x00,0x00],':':[0x00,0x36,0x36,0x00,0x00],
        ' ':[0x00,0x00,0x00,0x00,0x00],':':[0x00,0x36,0x36,0x00,0x00],
        '-':[0x08,0x08,0x08,0x08,0x08],'.':[0x00,0x60,0x60,0x00,0x00]
    }

    def __init__(self, tft, scale=2, color=0xFFFF):
        self.tft = tft
        self.scale = scale
        self.color = color

    def draw_char(self, x, y, ch):
        glyph = self.FONT.get(ch, self.FONT[' '])
        for col in range(5):
            line = glyph[col]
            for row in range(7):
                if line & 1:
                    for dx in range(self.scale):
                        for dy in range(self.scale):
                            self.tft.drawPixel(x + col*self.scale + dx, y + row*self.scale + dy, self.color)
                line >>= 1

    def print(self, x, y, text):
        self.tft.fillRect(x, y, 320, 7*self.scale, 0x0000)
        for ch in text:
            self.draw_char(x, y, ch)
            x += (6 * self.scale)

# ================= INITIALIZE TEXT =================
txt = LargeText(tft, scale=2)

# ================= DISPLAY WELCOME =================
txt.print(10, 10, "WELCOME TO SIGNALSYNC")
txt.print(10, 40, "IRS SYSTEM READY")

# ================= SERVO =================
servo1 = PWM(Pin(26), freq=50)
servo2 = PWM(Pin(27), freq=50)

def move_servos(angle):
    duty = int((angle / 180) * 102 + 26)
    servo1.duty(duty)
    servo2.duty(duty)
    time.sleep(0.7)
    servo1.duty(0)
    servo2.duty(0)

# ================= RGB =================
red = Pin(25, Pin.OUT)
blue = Pin(23, Pin.OUT)

def set_rgb(r, b):
    red.value(r)
    blue.value(b)

# ================= WIFI =================
SSID = "Samiksha"
PASSWORD = "samysays"

wifi = network.WLAN(network.STA_IF)
wifi.active(True)
wifi.connect(SSID, PASSWORD)

while not wifi.isconnected():
    time.sleep(1)

# ================= THINGSPEAK =================
CHANNEL_ID = "3232555"
READ_API_KEY = "O5ISQ8GA969Z01WG"
url = f"http://api.thingspeak.com/channels/{CHANNEL_ID}/feeds.json?api_key={READ_API_KEY}&results=1"

# ================= MAIN LOOP =================
while True:
    try:
        r = urequests.get(url)
        data = r.json()
        r.close()

        if data["feeds"]:
            rssi_val = int(float(data["feeds"][-1]["field1"]))

            if -100 <= rssi_val <= -70:
                angle = int(((rssi_val + 100) / 30) * 180)
                move_servos(angle)
                set_rgb(1, 0)
                status = "SIGNAL LOW"
                led = "RED"
            else:
                set_rgb(0, 1)
                status = "SIGNAL OK "
                led = "GREEN"

            txt.print(10, 80, f"{status} RSSI:{rssi_val}")
            txt.print(10, 110, f"LED STATUS:{led}")

    except Exception as e:
        txt.print(10, 80, "ERROR")
        txt.print(10, 110, str(e)[:20])

    time.sleep(15)